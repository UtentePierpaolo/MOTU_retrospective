# another (API,ATC) couple is available, use this information
# av_APIATC <- AIFA_ahcnn_tn_ATC[!is.na(AIFA_ahcnn_tn_ATC$ATC),]
# ...
# where ATC is present
AIFA_ahcnn_tn_ATCp <- AIFA_ahcnn_tn_ATC[!is.na(AIFA_ahcnn_tn_ATC$ATC),]
# where ATC is missing
AIFA_ahcnn_tn_ATCm <- AIFA_ahcnn_tn_ATC[is.na(AIFA_ahcnn_tn_ATC$ATC),]
AIFA_ahcnn_tn_ATCm <- AIFA_ahcnn_tn_ATCm[!(AIFA_ahcnn_tn_ATCm$Principio.Attivo %in% AIFA_ahcnn_tn_ATCp$Principio.Attivo),]
# stack
AIFA_ahcnn_tn_ATC <- rbind(AIFA_ahcnn_tn_ATCp,AIFA_ahcnn_tn_ATCm)
grep(x=AIFA_ahcnn_tn_ATC$Denominazione.e.Confezione, pattern="connettivina")
View(AIFA_ahcnn_tn_ATC)
varCCL_LISTEFARMACI <- c("CDN_ANNO","LIFACOCAIDCO","PRG_LISTA","IND_TIPO","DAT_INIZIO","DAT_FINE","PRG_FARMACO")
dfmsl <- merge(CCL_SOMMINFARMAC, CCL_LISTEFARMACI[,varCCL_LISTEFARMACI],
by.x=c("CDN_ANNO","CDN_COMMESSA","PRG_LISTAFAR"), by.y=c("CDN_ANNO","LIFACOCAIDCO","PRG_LISTA"))
dfmsl <- merge(dfmsl, CCL_FARMACI[,c("PRG_FARMACO","DES_FARMACO")], by="PRG_FARMACO")
dfmslr <- unique(dfmsl[,c("CDN_ANNO","CDN_COMMESSA","DES_FARMACO")])
tdf1 <- merge(dfmslr, includedHospitalStays, by=c("CDN_ANNO","CDN_COMMESSA"), all.y=T)
# all drugs of included hospital stays
allindrugs <- unique(tdf1$Drugs)
allindrugs <- allindrugs[!is.na(allindrugs)]
dfindrugs <- data.frame(indrugs=allindrugs)
# truncate at first number
dfindrugs$indrugsc <- gsub(" ([0-9]+).*$", "", allindrugs)
# all drugs of included hospital stays
allindrugs <- unique(tdf1$Drugs)
head(tdf1)
dfmsl <- merge(CCL_SOMMINFARMAC, CCL_LISTEFARMACI[,varCCL_LISTEFARMACI],
by.x=c("CDN_ANNO","CDN_COMMESSA","PRG_LISTAFAR"), by.y=c("CDN_ANNO","LIFACOCAIDCO","PRG_LISTA"))
dfmsl <- merge(dfmsl, CCL_FARMACI[,c("PRG_FARMACO","DES_FARMACO")], by="PRG_FARMACO")
dfmslr <- unique(dfmsl[,c("CDN_ANNO","CDN_COMMESSA","DES_FARMACO")])
tdf1 <- merge(dfmslr, includedHospitalStays, by=c("CDN_ANNO","CDN_COMMESSA"), all.y=T)
View(tdf1)
names(tdf1)
names(tdf1)[names(tdf1)=="DES_FARMACO"] <- "Drug"
names(tdf1)
tdf1 <- tdf1[!is.na(tdf1$Drug),]
# all drugs of included hospital stays
allindrugs <- unique(tdf1$Drug)
allindrugs <- allindrugs[!is.na(allindrugs)]
dfindrugs <- data.frame(indrugs=allindrugs)
# truncate at first number
dfindrugs$indrugsc <- gsub(" ([0-9]+).*$", "", allindrugs)
names(AIFA_ahcnn_tn_ATC)
# associate active principle ingredient
dfindrugs <- merge(dfindrugs, AIFA_ahcnn_tn_ATC,
all.x=T, by.x="indrugsc",by.y="Denominazione.e.Confezione")
View(dfindrugs)
# truncate at first number and to lower
tdf1$Drug <- tolower(gsub(" ([0-9]+).*$", "", tdf1$Drug))
tdf1 <- merge(tdf1, AIFA_ahcnn_tn_ATC, all.x=T, by.x="Drug", by.y="Denominazione.e.Confezione")
tdf1 <- merge(dfmslr, includedHospitalStays, by=c("CDN_ANNO","CDN_COMMESSA"), all.y=T)
names(tdf1)[names(tdf1)=="DES_FARMACO"] <- "Drug"
tdf1 <- tdf1[!is.na(tdf1$Drug),]
# truncate at first number and to lower
tdf1$Drug <- tolower(gsub(" ([0-9]+).*$", "", tdf1$Drug))
tdf1 <- merge(tdf1, AIFA_ahcnn_tn_ATC, all.x=T, by.x="Drug", by.y="Denominazione.e.Confezione")
tdf1 <- merge(dfmslr, includedHospitalStays, by=c("CDN_ANNO","CDN_COMMESSA"), all.y=T)
names(tdf1)[names(tdf1)=="DES_FARMACO"] <- "Drug"
tdf1 <- tdf1[!is.na(tdf1$Drug),]
# truncate at first number and to lower
tdf1$Drug <- tolower(gsub(" ([0-9]+).*$", "", tdf1$Drug))
tdf2 <- merge(tdf1, AIFA_ahcnn_tn_ATC, all.x=T, by.x="Drug", by.y="Denominazione.e.Confezione")
# see where ATC not found
sum(is.na(tdf2$ATC))
allindrugs <- unique(tdf2[,c("Drug","Principio.Attivo","ATC")])
dfindrugs <- unique(tdf2[,c("Drug","Principio.Attivo","ATC")])
sum(is.na(dfindrugs$ATC))
View(dfindrugs)
dfindrugs$Drug[10]
dfindrugs$Drug[1:10]
head(AIFA_gn$Confezione.di.riferimento)
head(AIFA_gn$Farmaco)
View(AIFA_gn$Farmaco)
View(AIFA_gn)
grep(x=AIFA_gn$Principio.attivo, pattern = "acido acetilsalici")
AIFA_gn[grep(x=AIFA_gn$Principio.attivo, pattern = "acido acetilsalici"),"Principio.attivo"]
unique(AIFA_gn[grep(x=AIFA_gn$Principio.attivo, pattern = "acido acetilsalici"),"Principio.attivo"])
unique(AIFA_gn[grep(x=tolower(AIFA_gn$Farmaco), pattern = "acido acetilsalici"),"Farmaco"])
dfindrugs[grep(x=dfindrugs$Principio.Attivo, pattern="/"),]
dim(dfindrugs[grep(x=dfindrugs$Principio.Attivo, pattern="/"),])
rm(list=ls())
addrData <- "C:/Users/p-pie/OneDrive - Alma Mater Studiorum Università di Bologna/MOTU/retrospective study/Data/"
# load included hospital stays
load(paste0(addrData,"Data res/Update2021/EligibleIncluded_20112020.RData"))
# load drug information from INAIL DB
CCL_SOMMINFARMAC <- read.csv(file=paste0(addrData,"Query results/Update2021/CCL_SOMMINFARMAC.csv"))
CCL_FARMACI <- read.csv(paste0(addrData,"Query results/Update2021/CCL_FARMACI.csv"))
CCL_LISTEFARMACI <- read.csv(paste0(addrData,"Query results/Update2021/CCL_LISTEFARMACI.csv"))
# load drug lists from AIFA tables
# class A
AIFA_a_tn <- read.csv2(paste0(addrData,"Drugs/AIFA/Classe_A_ per_nome_commerciale_15-01-2021.csv")) # trade name
# AIFA_a_api <- read.csv2(paste0(addrData,"Drugs/AIFA/Classe_A_per_principio_attivo_15-01-2021.csv")) # active pharmaceutical ingredient
# class H
AIFA_h_tn <- read.csv2(paste0(addrData,"Drugs/AIFA/Classe_H_per_nome_commerciale_15-01-2021.csv"))
# AIFA_h_api <- read.csv2(paste0(addrData,"Drugs/AIFA/Classe_H_per_principio_attivo_15-01-2021.csv"))
# class Cnn (nn=non negoziati)
AIFA_cnn <- read.csv2(paste0(addrData,"Drugs/AIFA/lista_farmaci_valutati_inserimento_classe_Cnn_25.06.2021.csv"))
AIFA_cnn <- AIFA_cnn[,1:17]
# non-proprietary (generic) names
AIFA_gn <- read.csv2(paste0(addrData,"Drugs/AIFA/Lista_farmaci_equivalenti.csv"))
# functions-----------------------
# see one-to-many correspondences
seemultiple <- function(dfr,v1,v2){
# dfrinc must be a data.frame with
# v1: variable that is repeated (one)
# v2: variable that varies for fixed v1 (many)
dfr <- unique(dfr[,c(v1,v2)])
wd <- duplicated(dfr[,v1]) | duplicated(dfr[,v1], fromLast = T)
dfr <- dfr[wd,]
dfr <- dfr[order(dfr[,v1]),]
return(dfr)
}
# class A and H drugs
# stack class A and H drugs one over the other
AIFA_a_tn <- AIFA_a_tn[,c("Denominazione.e.Confezione","Principio.Attivo")] # "Codice.Gruppo.Equivalenza",
AIFA_h_tn <- AIFA_h_tn[,c("Denominazione.e.Confezione","Principio.Attivo")] # "Codice.Gruppo.Equivalenza",
AIFA_ah_tn <- rbind(AIFA_a_tn,AIFA_h_tn)
# truncate before *
AIFA_ah_tn[,"Denominazione.e.Confezione"] <- sub("\\*.*", "", AIFA_ah_tn[,"Denominazione.e.Confezione"])
# to lower
AIFA_ah_tn$Denominazione.e.Confezione <- tolower(AIFA_ah_tn$Denominazione.e.Confezione)
AIFA_ah_tn$Principio.Attivo <- tolower(AIFA_ah_tn$Principio.Attivo)
# unique
AIFA_ah_tn <- unique(AIFA_ah_tn)
AIFA_gn$Principio.attivo <- tolower(AIFA_gn$Principio.attivo)
grep(x=AIFA_ah_tn$Principio.Attivo, pattern="/")
AIFA_ah_tn[grep(x=AIFA_ah_tn$Principio.Attivo, pattern="/"),"Principio.attivo"]
AIFA_ah_tn[grep(x=AIFA_ah_tn$Principio.Attivo, pattern="/"),]
AIFA_ah_tn[grep(x=AIFA_ah_tn$Principio.Attivo, pattern="/"),"Principio.Attivo"]
AIFA_gn[grep(x=AIFA_gn$Principio.attivo, pattern="/"),"Principio.attivo"]
View(AIFA_gn[grep(x=AIFA_gn$Principio.attivo, pattern="/"),])
sum(is.na(dfindrugs$ATC))
rm(list=ls())
addrData <- "C:/Users/p-pie/OneDrive - Alma Mater Studiorum Università di Bologna/MOTU/retrospective study/Data/"
# load included hospital stays
load(paste0(addrData,"Data res/Update2021/EligibleIncluded_20112020.RData"))
# load drug information from INAIL DB
CCL_SOMMINFARMAC <- read.csv(file=paste0(addrData,"Query results/Update2021/CCL_SOMMINFARMAC.csv"))
CCL_FARMACI <- read.csv(paste0(addrData,"Query results/Update2021/CCL_FARMACI.csv"))
CCL_LISTEFARMACI <- read.csv(paste0(addrData,"Query results/Update2021/CCL_LISTEFARMACI.csv"))
# load drug lists from AIFA tables
# class A
AIFA_a_tn <- read.csv2(paste0(addrData,"Drugs/AIFA/Classe_A_ per_nome_commerciale_15-01-2021.csv")) # trade name
# AIFA_a_api <- read.csv2(paste0(addrData,"Drugs/AIFA/Classe_A_per_principio_attivo_15-01-2021.csv")) # active pharmaceutical ingredient
# class H
AIFA_h_tn <- read.csv2(paste0(addrData,"Drugs/AIFA/Classe_H_per_nome_commerciale_15-01-2021.csv"))
# AIFA_h_api <- read.csv2(paste0(addrData,"Drugs/AIFA/Classe_H_per_principio_attivo_15-01-2021.csv"))
# class Cnn (nn=non negoziati)
AIFA_cnn <- read.csv2(paste0(addrData,"Drugs/AIFA/lista_farmaci_valutati_inserimento_classe_Cnn_25.06.2021.csv"))
AIFA_cnn <- AIFA_cnn[,1:17]
# non-proprietary (generic) names
AIFA_gn <- read.csv2(paste0(addrData,"Drugs/AIFA/Lista_farmaci_equivalenti.csv"))
# functions-----------------------
# see one-to-many correspondences
seemultiple <- function(dfr,v1,v2){
# dfrinc must be a data.frame with
# v1: variable that is repeated (one)
# v2: variable that varies for fixed v1 (many)
dfr <- unique(dfr[,c(v1,v2)])
wd <- duplicated(dfr[,v1]) | duplicated(dfr[,v1], fromLast = T)
dfr <- dfr[wd,]
dfr <- dfr[order(dfr[,v1]),]
return(dfr)
}
# class A and H drugs
# stack class A and H drugs one over the other
AIFA_a_tn <- AIFA_a_tn[,c("Denominazione.e.Confezione","Principio.Attivo")] # "Codice.Gruppo.Equivalenza",
AIFA_h_tn <- AIFA_h_tn[,c("Denominazione.e.Confezione","Principio.Attivo")] # "Codice.Gruppo.Equivalenza",
AIFA_ah_tn <- rbind(AIFA_a_tn,AIFA_h_tn)
# truncate before *
AIFA_ah_tn[,"Denominazione.e.Confezione"] <- sub("\\*.*", "", AIFA_ah_tn[,"Denominazione.e.Confezione"])
# to lower
AIFA_ah_tn$Denominazione.e.Confezione <- tolower(AIFA_ah_tn$Denominazione.e.Confezione)
AIFA_ah_tn$Principio.Attivo <- tolower(AIFA_ah_tn$Principio.Attivo)
# unique
AIFA_ah_tn <- unique(AIFA_ah_tn)
AIFA_gn$Principio.attivo <- tolower(AIFA_gn$Principio.attivo)
# associate trade names to ATC code
AIFA_ah_tn_ATC <- merge(AIFA_ah_tn, AIFA_gn[,c("Principio.attivo","ATC")],
all.x=T, by.x="Principio.Attivo", by.y="Principio.attivo")
sum(is.na(AIFA_ah_tn_ATC$ATC))
# pre-process class Cnn drugs
names(AIFA_cnn)[names(AIFA_cnn)=="DENOMINAZIONE.FARMACO...con.link.all.EPAR."] <- "Denominazione.e.Confezione"
names(AIFA_cnn)[names(AIFA_cnn)=="PRINCIPIO.ATTIVO"] <- "Principio.Attivo"
AIFA_cnn$Denominazione.e.Confezione <- tolower(AIFA_cnn$Denominazione.e.Confezione)
AIFA_cnn$Principio.Attivo <- tolower(AIFA_cnn$Principio.Attivo)
# stack A,H with Cnn
cvar <- c("Denominazione.e.Confezione","Principio.Attivo","ATC")
AIFA_ahcnn_tn_ATC <- unique(rbind(AIFA_ah_tn_ATC[,cvar], AIFA_cnn[,cvar]))
ws <- substring(AIFA_ahcnn_tn_ATC$Principio.Attivo,1,1)==" "
AIFA_ahcnn_tn_ATC[ws,"Principio.Attivo"] <- substring(AIFA_ahcnn_tn_ATC[ws,"Principio.Attivo"],2)
wp <- grep(x=AIFA_ahcnn_tn_ATC$ATC, pattern="Pending", ignore.case = T)
AIFA_ahcnn_tn_ATC[wp,"ATC"] <- NA
# between NA and a proper ATC, choose the ATC:
# if an ATC is missing and
# another (API,ATC) couple is available, use this information
# where ATC is present
AIFA_ahcnn_tn_ATCp <- AIFA_ahcnn_tn_ATC[!is.na(AIFA_ahcnn_tn_ATC$ATC),]
# where ATC is missing
AIFA_ahcnn_tn_ATCm <- AIFA_ahcnn_tn_ATC[is.na(AIFA_ahcnn_tn_ATC$ATC),]
AIFA_ahcnn_tn_ATCm <- AIFA_ahcnn_tn_ATCm[!(AIFA_ahcnn_tn_ATCm$Principio.Attivo %in% AIFA_ahcnn_tn_ATCp$Principio.Attivo),]
# stack
AIFA_ahcnn_tn_ATC <- rbind(AIFA_ahcnn_tn_ATCp,AIFA_ahcnn_tn_ATCm)
varCCL_LISTEFARMACI <- c("CDN_ANNO","LIFACOCAIDCO","PRG_LISTA","IND_TIPO","DAT_INIZIO","DAT_FINE","PRG_FARMACO")
dfmsl <- merge(CCL_SOMMINFARMAC, CCL_LISTEFARMACI[,varCCL_LISTEFARMACI],
by.x=c("CDN_ANNO","CDN_COMMESSA","PRG_LISTAFAR"), by.y=c("CDN_ANNO","LIFACOCAIDCO","PRG_LISTA"))
dfmsl <- merge(dfmsl, CCL_FARMACI[,c("PRG_FARMACO","DES_FARMACO")], by="PRG_FARMACO")
dfmslr <- unique(dfmsl[,c("CDN_ANNO","CDN_COMMESSA","DES_FARMACO")])
tdf1 <- merge(dfmslr, includedHospitalStays, by=c("CDN_ANNO","CDN_COMMESSA"), all.y=T)
names(tdf1)[names(tdf1)=="DES_FARMACO"] <- "Drug"
tdf1 <- tdf1[!is.na(tdf1$Drug),]
# truncate at first number and to lower
tdf1$Drug <- tolower(gsub(" ([0-9]+).*$", "", tdf1$Drug))
# drug name - ATC code---------
tdf2 <- merge(tdf1, AIFA_ahcnn_tn_ATC, all.x=T, by.x="Drug", by.y="Denominazione.e.Confezione")
# see where ATC not found
sum(is.na(tdf2$ATC))
dfindrugs <- unique(tdf2[,c("Drug","Principio.Attivo","ATC")])
sum(is.na(dfindrugs$ATC))
dfindrugs[grep(x=dfindrugs$Principio.Attivo, pattern="/"),]
dfindrugs[grep(x=dfindrugs$Principio.Attivo, pattern="+"),]
View(dfindrugs[grep(x=dfindrugs$Principio.Attivo, pattern="+"),])
View(dfindrugs[grep(x=dfindrugs$Principio.Attivo, pattern="\+"),])
View(dfindrugs[grep(x=dfindrugs$Principio.Attivo, pattern="\\+"),])
View(dfindrugs[grep(x=dfindrugs$Principio.Attivo, pattern=" + "),])
View(dfindrugs[grep(x=dfindrugs$Principio.Attivo, pattern=" \+ "),])
View(dfindrugs[grep(x=dfindrugs$Principio.Attivo, pattern=" \\+ "),])
load(paste0(addrData,"hs_drugclass_v2.RData"))
paste0(addrData,"hs_drugclass_v2.RData")
load(paste0(addrData,"Drugs/hs_drugclass_v2.RData"))
rm(list=ls())
load(paste0(addrData,"Drugs/hs_drugclass_v2.RData"))
addrData <- "C:/Users/p-pie/OneDrive - Alma Mater Studiorum Università di Bologna/MOTU/retrospective study/Data/"
load(paste0(addrData,"Drugs/hs_drugclass_v2.RData"))
View(dfm_drugs)
load(paste0(addrData,"Drugs/hs_drugclass.RData"))
View(dfm_drugs)
load(paste0(addrData,"Drugs/hs_drugclass_v2.RData"))
View(dfm_drugs)
rm(list=ls())
addrData <- "C:/Users/p-pie/OneDrive - Alma Mater Studiorum Università di Bologna/MOTU/retrospective study/Data/"
# load included hospital stays
load(paste0(addrData,"Data res/Update2021/EligibleIncluded_20112020.RData"))
# load drug information from INAIL DB
CCL_SOMMINFARMAC <- read.csv(file=paste0(addrData,"Query results/Update2021/CCL_SOMMINFARMAC.csv"))
CCL_FARMACI <- read.csv(paste0(addrData,"Query results/Update2021/CCL_FARMACI.csv"))
CCL_LISTEFARMACI <- read.csv(paste0(addrData,"Query results/Update2021/CCL_LISTEFARMACI.csv"))
# load drug lists from AIFA tables
# class A
AIFA_a_tn <- read.csv2(paste0(addrData,"Drugs/AIFA/Classe_A_ per_nome_commerciale_15-01-2021.csv")) # trade name
# AIFA_a_api <- read.csv2(paste0(addrData,"Drugs/AIFA/Classe_A_per_principio_attivo_15-01-2021.csv")) # active pharmaceutical ingredient
# class H
AIFA_h_tn <- read.csv2(paste0(addrData,"Drugs/AIFA/Classe_H_per_nome_commerciale_15-01-2021.csv"))
# AIFA_h_api <- read.csv2(paste0(addrData,"Drugs/AIFA/Classe_H_per_principio_attivo_15-01-2021.csv"))
# class Cnn (nn=non negoziati)
AIFA_cnn <- read.csv2(paste0(addrData,"Drugs/AIFA/lista_farmaci_valutati_inserimento_classe_Cnn_25.06.2021.csv"))
AIFA_cnn <- AIFA_cnn[,1:17]
# non-proprietary (generic) names
AIFA_gn <- read.csv2(paste0(addrData,"Drugs/AIFA/Lista_farmaci_equivalenti.csv"))
# functions-----------------------
# see one-to-many correspondences
seemultiple <- function(dfr,v1,v2){
# dfrinc must be a data.frame with
# v1: variable that is repeated (one)
# v2: variable that varies for fixed v1 (many)
dfr <- unique(dfr[,c(v1,v2)])
wd <- duplicated(dfr[,v1]) | duplicated(dfr[,v1], fromLast = T)
dfr <- dfr[wd,]
dfr <- dfr[order(dfr[,v1]),]
return(dfr)
}
# class A and H drugs
# stack class A and H drugs one over the other
AIFA_a_tn <- AIFA_a_tn[,c("Denominazione.e.Confezione","Principio.Attivo")] # "Codice.Gruppo.Equivalenza",
AIFA_h_tn <- AIFA_h_tn[,c("Denominazione.e.Confezione","Principio.Attivo")] # "Codice.Gruppo.Equivalenza",
AIFA_ah_tn <- rbind(AIFA_a_tn,AIFA_h_tn)
# truncate before *
AIFA_ah_tn[,"Denominazione.e.Confezione"] <- sub("\\*.*", "", AIFA_ah_tn[,"Denominazione.e.Confezione"])
# to lower
AIFA_ah_tn$Denominazione.e.Confezione <- tolower(AIFA_ah_tn$Denominazione.e.Confezione)
AIFA_ah_tn$Principio.Attivo <- tolower(AIFA_ah_tn$Principio.Attivo)
# unique
AIFA_ah_tn <- unique(AIFA_ah_tn)
AIFA_gn$Principio.attivo <- tolower(AIFA_gn$Principio.attivo)
# associate trade names to ATC code
AIFA_ah_tn_ATC <- merge(AIFA_ah_tn, AIFA_gn[,c("Principio.attivo","ATC")],
all.x=T, by.x="Principio.Attivo", by.y="Principio.attivo")
sum(is.na(AIFA_ah_tn_ATC$ATC))
# pre-process class Cnn drugs
names(AIFA_cnn)[names(AIFA_cnn)=="DENOMINAZIONE.FARMACO...con.link.all.EPAR."] <- "Denominazione.e.Confezione"
names(AIFA_cnn)[names(AIFA_cnn)=="PRINCIPIO.ATTIVO"] <- "Principio.Attivo"
AIFA_cnn$Denominazione.e.Confezione <- tolower(AIFA_cnn$Denominazione.e.Confezione)
AIFA_cnn$Principio.Attivo <- tolower(AIFA_cnn$Principio.Attivo)
# stack A,H with Cnn
cvar <- c("Denominazione.e.Confezione","Principio.Attivo","ATC")
AIFA_ahcnn_tn_ATC <- unique(rbind(AIFA_ah_tn_ATC[,cvar], AIFA_cnn[,cvar]))
ws <- substring(AIFA_ahcnn_tn_ATC$Principio.Attivo,1,1)==" "
AIFA_ahcnn_tn_ATC[ws,"Principio.Attivo"] <- substring(AIFA_ahcnn_tn_ATC[ws,"Principio.Attivo"],2)
wp <- grep(x=AIFA_ahcnn_tn_ATC$ATC, pattern="Pending", ignore.case = T)
AIFA_ahcnn_tn_ATC[wp,"ATC"] <- NA
# between NA and a proper ATC, choose the ATC:
# if an ATC is missing and
# another (API,ATC) couple is available, use this information
# where ATC is present
AIFA_ahcnn_tn_ATCp <- AIFA_ahcnn_tn_ATC[!is.na(AIFA_ahcnn_tn_ATC$ATC),]
# where ATC is missing
AIFA_ahcnn_tn_ATCm <- AIFA_ahcnn_tn_ATC[is.na(AIFA_ahcnn_tn_ATC$ATC),]
AIFA_ahcnn_tn_ATCm <- AIFA_ahcnn_tn_ATCm[!(AIFA_ahcnn_tn_ATCm$Principio.Attivo %in% AIFA_ahcnn_tn_ATCp$Principio.Attivo),]
# stack
AIFA_ahcnn_tn_ATC <- rbind(AIFA_ahcnn_tn_ATCp,AIFA_ahcnn_tn_ATCm)
varCCL_LISTEFARMACI <- c("CDN_ANNO","LIFACOCAIDCO","PRG_LISTA","IND_TIPO","DAT_INIZIO","DAT_FINE","PRG_FARMACO")
dfmsl <- merge(CCL_SOMMINFARMAC, CCL_LISTEFARMACI[,varCCL_LISTEFARMACI],
by.x=c("CDN_ANNO","CDN_COMMESSA","PRG_LISTAFAR"), by.y=c("CDN_ANNO","LIFACOCAIDCO","PRG_LISTA"))
dfmsl <- merge(dfmsl, CCL_FARMACI[,c("PRG_FARMACO","DES_FARMACO")], by="PRG_FARMACO")
dfmslr <- unique(dfmsl[,c("CDN_ANNO","CDN_COMMESSA","DES_FARMACO")])
tdf1 <- merge(dfmslr, includedHospitalStays, by=c("CDN_ANNO","CDN_COMMESSA"), all.y=T)
names(tdf1)[names(tdf1)=="DES_FARMACO"] <- "Drug"
tdf1 <- tdf1[!is.na(tdf1$Drug),]
# truncate at first number and to lower
tdf1$Drug <- tolower(gsub(" ([0-9]+).*$", "", tdf1$Drug))
# drug name - ATC code---------
tdf2 <- merge(tdf1, AIFA_ahcnn_tn_ATC, all.x=T, by.x="Drug", by.y="Denominazione.e.Confezione")
# see where ATC not found
sum(is.na(tdf2$ATC))
dfindrugs <- unique(tdf2[,c("Drug","Principio.Attivo","ATC")])
sum(is.na(dfindrugs$ATC))
dfindrugs[grep(x=dfindrugs$Principio.Attivo, pattern="/"),]
View(is.na(dfindrugs$ATC))
View(dfindrugs[is.na(dfindrugs$ATC),])
require(readxl)
# tables Gloria Marasco
read_xls(paste0(addrData,"Drugs/HS_ATC_Gloria_27032020.xls"))
?read_xls
# tables Gloria Marasco
fpgl <- as.data.frame(read_xls(paste0(addrData,"Drugs/HS_ATC_Gloria_27032020.xls", sheet="farmaci paz")))
# tables Gloria Marasco
fpgl <- as.data.frame(read_xls(paste0(addrData,"Drugs/HS_ATC_Gloria_27032020.xls", sheet="farmaci paz")))
# tables Gloria Marasco
fpgl <- as.data.frame(read_xls(paste0(addrData,"Drugs/HS_ATC_Gloria_27032020.xls"),sheet="farmaci paz"))
View(fpgl)
View(dfindrugs[is.na(dfindrugs$ATC),])
dfindrugs_m <- dfindrugs[is.na(dfindrugs$ATC),]
# pre-process Gloria Marasco's table
fpgl$farmaco <- tolower(fpgl$farmaco)
fpgl$f2 <- tolower(fpgl$f2)
varCCL_LISTEFARMACI
names(fpgl)
dfindrugs_mf <- merge(dfindrugs_m[,c("Drug","Principio.attivo")], fpgl[,c("farmaco","atc")],
all.x=T, by.x="Drug", by.y="farmaco")
dfindrugs_m <- dfindrugs[is.na(dfindrugs$ATC),]
dfindrugs_m[,c("Drug","Principio.attivo")]
names(dfindrugs_m)
dfindrugs_mf <- merge(dfindrugs_m[,c("Drug","Principio.Attivo")], fpgl[,c("farmaco","atc")],
all.x=T, by.x="Drug", by.y="farmaco")
View(dfindrugs_mf)
names(fpgl)
dfindrugs_mf <- merge(dfindrugs_m[,c("Drug","Principio.Attivo")], fpgl[,c("farmaco", "principio attivo","atc")],
all.x=T, by.x="Drug", by.y="farmaco")
View(dfindrugs_mf)
sum(is.na(dfindrugs_mf$atc))
nrow(dfindrugs_mf)
dfindrugs_mf <- merge(dfindrugs_m[,c("Drug","Principio.Attivo")], fpgl[,c("farmaco", "f2","principio attivo","atc")],
all.x=T, by.x="Drug", by.y="f2")
sum(is.na(dfindrugs_mf$atc))
sum(is.na(dfindrugs_mf$atc))
sum(is.na(dfindrugs_mf$Principio.Attivo))
wapina <- which(is.na(dfindrugs_mf$Principio.Attivo))
dfindrugs_mf[wapina,"Principio.Attivo"] <- dfindrugs_mf[wapina,"principio attivo"]
sum(is.na(dfindrugs_mf$Principio.Attivo))
names(fpgl)[names(fpgl)=="atc"] <- "ATC"
dfindrugs_mf <- merge(dfindrugs_m[,c("Drug","Principio.Attivo")], fpgl[,c("farmaco", "principio attivo","ATC")],
all.x=T, by.x="Drug", by.y="f2")
sum(is.na(dfindrugs_mf$atc))
wapina <- which(is.na(dfindrugs_mf$Principio.Attivo))
dfindrugs_mf[wapina,"Principio.Attivo"] <- dfindrugs_mf[wapina,"principio attivo"]
dfindrugs_2 <- rbind(dfindrugs[!is.na(dfindrugs$ATC),], dfindrugs_mf)
names(dfindrugs)
names(dfindrugs_mf)
# add information from Gloria Marasco
dfindrugs_m <- dfindrugs[is.na(dfindrugs$ATC),]
dfindrugs_mf <- merge(dfindrugs_m[,c("Drug","Principio.Attivo")], fpgl[,c("farmaco", "principio attivo","ATC")],
all.x=T, by.x="Drug", by.y="farmaco")
sum(is.na(dfindrugs_mf$atc))
sum(is.na(dfindrugs_mf$ATC))
wapina <- which(is.na(dfindrugs_mf$Principio.Attivo))
dfindrugs_mf[wapina,"Principio.Attivo"] <- dfindrugs_mf[wapina,"principio attivo"]
dfindrugs_2 <- rbind(dfindrugs[!is.na(dfindrugs$ATC),], dfindrugs_mf)
names(dfindrugs_mf)
dfindrugs_mf <- dfindrugs_mf[,c("Drug","Principio.Attivo","ATC")]
dfindrugs_2 <- rbind(dfindrugs[!is.na(dfindrugs$ATC),], dfindrugs_mf)
length(unique(fpgl$farmaco))
dim(fpgl)
seemultiple
seemultiple(dfr=fpgl,v1="farmaco",v2="ATC")
sum(is.na(fpgl$farmaco))
length(unique(fpgl$farmaco))
length(fpgl$farmaco)
fpgl <- unique(fpgl)
# tables Gloria Marasco
fpgl <- as.data.frame(read_xls(paste0(addrData,"Drugs/HS_ATC_Gloria_27032020.xls"),sheet="farmaci paz"))
# tables Gloria Marasco
fpgl <- unique(as.data.frame(read_xls(paste0(addrData,"Drugs/HS_ATC_Gloria_27032020.xls"),sheet="farmaci paz")))
# pre-process Gloria Marasco's table
fpgl$farmaco <- tolower(fpgl$farmaco)
fpgl$f2 <- tolower(fpgl$f2)
names(fpgl)[names(fpgl)=="atc"] <- "ATC"
fpgl <- unique(fpgl)
length(fpgl$farmaco)
seemultiple(dfr=fpgl,v1="farmaco",v2="ATC")
varCCL_LISTEFARMACI
dfmsl <- merge(CCL_SOMMINFARMAC, CCL_LISTEFARMACI[,varCCL_LISTEFARMACI],
by.x=c("CDN_ANNO","CDN_COMMESSA","PRG_LISTAFAR"), by.y=c("CDN_ANNO","LIFACOCAIDCO","PRG_LISTA"))
dfmsl <- merge(dfmsl, CCL_FARMACI[,c("PRG_FARMACO","DES_FARMACO")], by="PRG_FARMACO")
dfmslr <- unique(dfmsl[,c("CDN_ANNO","CDN_COMMESSA","DES_FARMACO")])
tdf1 <- merge(dfmslr, includedHospitalStays, by=c("CDN_ANNO","CDN_COMMESSA"), all.y=T)
names(tdf1)[names(tdf1)=="DES_FARMACO"] <- "Drug"
tdf1 <- tdf1[!is.na(tdf1$Drug),]
# truncate at first number and to lower
tdf1$Drug <- tolower(gsub(" ([0-9]+).*$", "", tdf1$Drug))
# drug name - ATC code---------
tdf2 <- merge(tdf1, AIFA_ahcnn_tn_ATC, all.x=T, by.x="Drug", by.y="Denominazione.e.Confezione")
# see where ATC not found
sum(is.na(tdf2$ATC))
dfindrugs <- unique(tdf2[,c("Drug","Principio.Attivo","ATC")])
sum(is.na(dfindrugs$ATC))
View(dfindrugs[is.na(dfindrugs$ATC),])
# add information from Gloria Marasco
dfindrugs_m <- dfindrugs[is.na(dfindrugs$ATC),]
dfindrugs_mf <- merge(dfindrugs_m[,c("Drug","Principio.Attivo")], fpgl[,c("farmaco", "principio attivo","ATC")],
all.x=T, by.x="Drug", by.y="farmaco")
sum(is.na(dfindrugs_mf$ATC))
wapina <- which(is.na(dfindrugs_mf$Principio.Attivo))
dfindrugs_mf[wapina,"Principio.Attivo"] <- dfindrugs_mf[wapina,"principio attivo"]
dfindrugs_mf <- dfindrugs_mf[,c("Drug","Principio.Attivo","ATC")]
dfindrugs_2 <- rbind(dfindrugs[!is.na(dfindrugs$ATC),], dfindrugs_mf)
sum(is.na(dfindrugs$ATC))
sum(is.na(dfindrugs_2$ATC))
View(dfindrugs_2[is.na(dfindrugs_2$ATC),])
View(dfindrugs[is.na(dfindrugs$ATC),])
length(unique(dfindrugs_2$Drug))
wm2 <- intersect(is.na(dfindrugs_m2$ATC), grep(x=dfindrugs_2$Principio.Attivo, pattern="/"))
wm2 <- intersect(is.na(dfindrugs_2$ATC), grep(x=dfindrugs_2$Principio.Attivo, pattern="/"))
wm2
wm2 <- intersect(which(is.na(dfindrugs_2$ATC)), grep(x=dfindrugs_2$Principio.Attivo, pattern="/"))
wm2
dfindrugs_m2 <- dfindrugs_2[wm2,]
View(dfindrugs_m2)
?strsplit
rm(list=ls())
require(readxl)
addrData <- "C:/Users/p-pie/OneDrive - Alma Mater Studiorum Università di Bologna/MOTU/retrospective study/Data/"
addrData2021 <- paste0(addrData,"Excel/Update2021/")
addrDataResOld <- paste0(addrData,"Data res/Old/")
source("C:/Users/p-pie/Dropbox/R/MOTU/add_AdmissionDate.R")
# data for the new tableFall
dff1 <- as.data.frame(read_xlsx(path=paste0(addrData2021,"Dati da cartella clinica-Falls-17_09_2020.xlsx")))
# old data for checks and comparisons
load(paste0(addrDataResOld,"Fall.RData"))
Fall_old <- Fall
rm(list="Fall")
# load included hospital stays
load(paste0(addrData,"Data res/Update2021/EligibleIncluded_20112020.RData"))
names(dff1)[names(dff1)=="indossava protesi"] <- "WearingProsthesis"
names(dff1)[names(dff1)=="Cosa faceva"] <- "FallActivity"
names(dff1)[names(dff1)=="Note"] <- "Notes"
dff2 <- dff1
dff2$AdmissionDate <- as.Date(dff2$AdmissionDate, format="%d_%m_%Y")
rm(list=ls())
require(readxl)
addrData <- "C:/Users/p-pie/OneDrive - Alma Mater Studiorum Università di Bologna/MOTU/retrospective study/Data/"
addrData2021 <- paste0(addrData,"Excel/Update2021/")
addrDataResOld <- paste0(addrData,"Data res/Old/")
source("C:/Users/p-pie/Dropbox/R/MOTU/add_AdmissionDate.R")
# data for the new tableFall
dff1 <- as.data.frame(read_xlsx(path=paste0(addrData2021,"Dati da cartella clinica-Falls-17_09_2020.xlsx")))
# old data for checks and comparisons
load(paste0(addrDataResOld,"Fall.RData"))
Fall_old <- Fall
rm(list="Fall")
# load included hospital stays
load(paste0(addrData,"Data res/Update2021/EligibleIncluded_20112020.RData"))
names(dff1)[names(dff1)=="indossava protesi"] <- "WearingProsthesis"
names(dff1)[names(dff1)=="Cosa faceva"] <- "FallActivity"
names(dff1)[names(dff1)=="Note"] <- "Notes"
dff1$AdmissionDate <- as.Date(dff1$AdmissionDate, format="%d_%m_%Y")
# View(dff1[is.na(dff1$AdmissionDate),])
dff1$DischargeDate <- as.Date(dff1$DischargeDate, format="%d_%m_%Y")
dff1$FallDate <- as.Date(dff1$FallDate, format="%d_%m_%Y")
# check dates 1
View(dff1[which(dff1$AdmissionDate > dff1$FallDate),])
View(dff1[is.na(dff1$AdmissionDate),])
View(dff1)
includedHospitalStays[includedHospitalStays$PatientID==36622,]
Fall_old[Fall_old$PatientID==36622,]
dfr
# load data
# old version: https://figshare.com/s/c84ae0d82a3e053ab668
dfr <- read.csv("AnonymisedData_21032021.csv",
stringsAsFactors=T)
setwd("C:/Users/p-pie/OneDrive - Alma Mater Studiorum Università di Bologna/MOTU/retrospective study/Code/MOTU_retrospective/")
# load data
# old version: https://figshare.com/s/c84ae0d82a3e053ab668
dfr <- read.csv("AnonymisedData_21032021.csv",
stringsAsFactors=T)
dfr[which(dfr$NumberAnyFall>0),]
View(dfr[which(dfr$NumberAnyFall>0),])
rm(list=ls())
rm(list=ls())
# load packages and data
require(lubridate)
load("D:/MOTU/retrospective study data/Data/HospitalStay_v1.7.Rdata")
